---
title: NginxçŸ¥è¯†ç‚¹æ€»ç»“ï¼ˆæŒç»­æ›´æ–°ï¼‰
author: Cynthia
categories:
  - ğŸ°æœªåˆ†ç±»ğŸ°
tags: []
date: 2019-05-05 16:00:59
---

ğŸ°
...
<!--more-->

## nginxåœ¨åº”ç”¨ç¨‹åºä¸­çš„ä½œç”¨

- è§£å†³è·¨åŸŸ
- è¯·æ±‚è¿‡æ»¤
- é…ç½®gzip
- è´Ÿè½½å‡è¡¡
- é™æ€èµ„æºæœåŠ¡å™¨

> nginxæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé€šç”¨çš„TCP/UDPä»£ç†æœåŠ¡å™¨ï¼Œæœ€åˆç”±ä¿„ç½—æ–¯äººIgor Sysoevç¼–å†™ã€‚

nginxç°åœ¨å‡ ä¹æ˜¯ä¼—å¤šå¤§å‹ç½‘ç«™çš„å¿…ç”¨æŠ€æœ¯ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦äº²è‡ªå»é…ç½®å®ƒï¼Œä½†æ˜¯äº†è§£å®ƒåœ¨åº”ç”¨ç¨‹åºä¸­æ‰€æ‹…ä»»çš„è§’è‰²ï¼Œä»¥åŠå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜æ˜¯éå¸¸å¿…è¦çš„ã€‚

ä¸‹é¢æˆ‘å°†ä»nginxåœ¨ä¼ä¸šä¸­çš„çœŸå®åº”ç”¨æ¥è§£é‡Šnginxåœ¨åº”ç”¨ç¨‹åºä¸­èµ·åˆ°çš„ä½œç”¨ã€‚

ä¸ºäº†ä¾¿äºç†è§£ï¼Œé¦–å…ˆå…ˆæ¥äº†è§£ä¸€ä¸‹ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œ`nginxæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„åå‘ä»£ç†æœåŠ¡å™¨`é‚£ä¹ˆä»€ä¹ˆæ˜¯åå‘ä»£ç†å‘¢ï¼Ÿ

## æ­£å‘ä»£ç†ä¸åå‘ä»£ç†

**ä»£ç†**æ˜¯åœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´å‡è®¾çš„ä¸€å±‚æœåŠ¡å™¨ï¼Œ**ä»£ç†**å°†æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶å°†å®ƒè½¬å‘ç»™æœåŠ¡å™¨ï¼Œç„¶åå°†æœåŠ¡ç«¯çš„å“åº”è½¬å‘ç»™å®¢æˆ·ç«¯ã€‚

ä¸ç®¡æ˜¯æ­£å‘ä»£ç†è¿˜æ˜¯åå‘ä»£ç†ï¼Œå®ç°çš„éƒ½æ˜¯ä¸Šé¢çš„åŠŸèƒ½ã€‚

![](https://raw.githubusercontent.com/Cynthia0329/images/master/img/20190505160918.png)

### æ­£å‘ä»£ç†

> **æ­£å‘ä»£ç†**ï¼Œæ„æ€æ˜¯ä¸€ä¸ªä½äºå®¢æˆ·ç«¯å’ŒåŸå§‹æœåŠ¡å™¨(origin server)ä¹‹é—´çš„æœåŠ¡å™¨ï¼Œä¸ºäº†ä»åŸå§‹æœåŠ¡å™¨å–å¾—å†…å®¹ï¼Œå®¢æˆ·ç«¯å‘ä»£ç†å‘é€ä¸€ä¸ªè¯·æ±‚å¹¶æŒ‡å®šç›®æ ‡(åŸå§‹æœåŠ¡å™¨)ï¼Œç„¶åä»£ç†å‘åŸå§‹æœåŠ¡å™¨è½¬äº¤è¯·æ±‚å¹¶å°†è·å¾—çš„å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

**æ­£å‘ä»£ç†**æ˜¯ä¸ºæˆ‘ä»¬æœåŠ¡çš„ï¼Œå³ä¸ºå®¢æˆ·ç«¯æœåŠ¡çš„ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ ¹æ®æ­£å‘ä»£ç†è®¿é—®åˆ°å®ƒæœ¬èº«æ— æ³•è®¿é—®åˆ°çš„æœåŠ¡å™¨èµ„æºã€‚

**æ­£å‘ä»£ç†**å¯¹æˆ‘ä»¬æ˜¯é€æ˜çš„ï¼Œå¯¹æœåŠ¡ç«¯æ˜¯éé€æ˜çš„ï¼Œå³æœåŠ¡ç«¯å¹¶ä¸çŸ¥é“è‡ªå·±æ”¶åˆ°çš„æ˜¯æ¥è‡ªä»£ç†çš„è®¿é—®è¿˜æ˜¯æ¥è‡ªçœŸå®å®¢æˆ·ç«¯çš„è®¿é—®ã€‚

### åå‘ä»£ç†

> **åå‘ä»£ç†**ï¼ˆReverse Proxyï¼‰æ–¹å¼æ˜¯æŒ‡ä»¥ä»£ç†æœåŠ¡å™¨æ¥æ¥å—internetä¸Šçš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œä¸Šçš„æœåŠ¡å™¨ï¼Œå¹¶å°†ä»æœåŠ¡å™¨ä¸Šå¾—åˆ°çš„ç»“æœè¿”å›ç»™internetä¸Šè¯·æ±‚è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ä»£ç†æœåŠ¡å™¨å¯¹å¤–å°±è¡¨ç°ä¸ºä¸€ä¸ªåå‘ä»£ç†æœåŠ¡å™¨ã€‚

**åå‘ä»£ç†**æ˜¯ä¸ºæœåŠ¡ç«¯æœåŠ¡çš„ï¼Œåå‘ä»£ç†å¯ä»¥å¸®åŠ©æœåŠ¡å™¨æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¸®åŠ©æœåŠ¡å™¨åšè¯·æ±‚è½¬å‘ï¼Œè´Ÿè½½å‡è¡¡ç­‰ã€‚

**åå‘ä»£ç†**å¯¹æœåŠ¡ç«¯æ˜¯é€æ˜çš„ï¼Œå¯¹æˆ‘ä»¬æ˜¯éé€æ˜çš„ï¼Œå³æˆ‘ä»¬å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä»£ç†æœåŠ¡å™¨ï¼Œè€ŒæœåŠ¡å™¨çŸ¥é“åå‘ä»£ç†åœ¨ä¸ºä»–æœåŠ¡ã€‚
![](https://raw.githubusercontent.com/Cynthia0329/images/master/img/20190505161010.png)

## åŸºæœ¬é…ç½®

### é…ç½®ç»“æ„

ä¸‹é¢æ˜¯ä¸€ä¸ªnginxé…ç½®æ–‡ä»¶çš„åŸºæœ¬ç»“æ„ï¼š

```
# ni
events { 

}

http 
{
    server
    { 
        location path
        {
            ...
        }
        location path
        {
            ...
        }
     }

    server
    {
        ...
    }

}
```

- `main`: nginxçš„å…¨å±€é…ç½®ï¼Œå¯¹å…¨å±€ç”Ÿæ•ˆã€‚
- `events`: é…ç½®å½±å“nginxæœåŠ¡å™¨æˆ–ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ã€‚
- `http`ï¼šå¯ä»¥åµŒå¥—å¤šä¸ªserverï¼Œé…ç½®ä»£ç†ï¼Œç¼“å­˜ï¼Œæ—¥å¿—å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ã€‚
- `server`ï¼šé…ç½®è™šæ‹Ÿä¸»æœºçš„ç›¸å…³å‚æ•°ï¼Œä¸€ä¸ªhttpä¸­å¯ä»¥æœ‰å¤šä¸ªserverã€‚
- `location`ï¼šé…ç½®è¯·æ±‚çš„è·¯ç”±ï¼Œä»¥åŠå„ç§é¡µé¢çš„å¤„ç†æƒ…å†µã€‚
- `upstream`ï¼šé…ç½®åç«¯æœåŠ¡å™¨å…·ä½“åœ°å€ï¼Œè´Ÿè½½å‡è¡¡é…ç½®ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚

### å†…ç½®å˜é‡

ä¸‹é¢æ˜¯ `nginx` ä¸€äº›é…ç½®ä¸­å¸¸ç”¨çš„å†…ç½®å…¨å±€å˜é‡ï¼Œä½ å¯ä»¥åœ¨é…ç½®çš„ä»»ä½•ä½ç½®ä½¿ç”¨å®ƒä»¬ã€‚

| å˜é‡å | åŠŸèƒ½ |
| ------ | ------ |
| $host| è¯·æ±‚ä¿¡æ¯ä¸­çš„Hostï¼Œå¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰Hostè¡Œï¼Œåˆ™ç­‰äºè®¾ç½®çš„æœåŠ¡å™¨å |
| $request_method | å®¢æˆ·ç«¯è¯·æ±‚ç±»å‹ï¼Œå¦‚GETã€POST |
| $remote_addr | å®¢æˆ·ç«¯çš„IPåœ°å€ |
|$args | è¯·æ±‚ä¸­çš„å‚æ•° |
|$content_length| è¯·æ±‚å¤´ä¸­çš„Content-lengthå­—æ®µ |
|$http_user_agent | å®¢æˆ·ç«¯agentä¿¡æ¯ |
|$http_cookie | å®¢æˆ·ç«¯cookieä¿¡æ¯ |
|$remote_addr | å®¢æˆ·ç«¯çš„IPåœ°å€ |
|$remote_port | å®¢æˆ·ç«¯çš„ç«¯å£ |
|$server_protocol | è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œå¦‚HTTP/1.0ã€Â·HTTP/1.1` |
|$server_addr | æœåŠ¡å™¨åœ°å€ |
|$server_name| æœåŠ¡å™¨åç§°|
|$server_port|æœåŠ¡å™¨çš„ç«¯å£å·|


## è§£å†³è·¨åŸŸ

å…ˆè¿½æœ¬æº¯æºä»¥ä¸‹ï¼Œè·¨åŸŸç©¶ç«Ÿæ˜¯æ€ä¹ˆå›äº‹ã€‚

### å®šä¹‰

**è·¨åŸŸçš„å®šä¹‰**

åŒæºç­–ç•¥é™åˆ¶äº†ä»åŒä¸€ä¸ªæºåŠ è½½çš„æ–‡æ¡£æˆ–è„šæœ¬å¦‚ä½•ä¸æ¥è‡ªå¦ä¸€ä¸ªæºçš„èµ„æºè¿›è¡Œäº¤äº’ã€‚è¿™æ˜¯ä¸€ä¸ªç”¨äºéš”ç¦»æ½œåœ¨æ¶æ„æ–‡ä»¶çš„é‡è¦å®‰å…¨æœºåˆ¶ã€‚é€šå¸¸ä¸å…è®¸ä¸åŒæºé—´çš„è¯»æ“ä½œã€‚

**åŒæºçš„å®šä¹‰**

å¦‚æœä¸¤ä¸ªé¡µé¢çš„åè®®ï¼Œç«¯å£ï¼ˆå¦‚æœæœ‰æŒ‡å®šï¼‰å’ŒåŸŸåéƒ½ç›¸åŒï¼Œåˆ™ä¸¤ä¸ªé¡µé¢å…·æœ‰ç›¸åŒçš„æºã€‚

![](https://raw.githubusercontent.com/Cynthia0329/images/master/img/20190505175354.png)

### nginxè§£å†³è·¨åŸŸçš„åŸç†

ä¾‹å¦‚ï¼š

- å‰ç«¯serverçš„åŸŸåä¸ºï¼š`fe.server.com`
- åç«¯æœåŠ¡çš„åŸŸåä¸ºï¼š`dev.server.com`

ç°åœ¨æˆ‘åœ¨å‰ç«¯ `fe.server.com` å¯¹åå° `dev.server.com` å‘èµ·è¯·æ±‚ä¸€å®šä¼šå‡ºç°è·¨åŸŸã€‚

> ç°åœ¨æˆ‘ä»¬åªéœ€è¦å¯åŠ¨ä¸€ä¸ªnginxæœåŠ¡å™¨ï¼š
>
> - å°† `server_name` è®¾ç½®ä¸º `fe.server.com` 
> - ç„¶åè®¾ç½®ç›¸åº”çš„ `location` ä»¥æ‹¦æˆªå‰ç«¯éœ€è¦è·¨åŸŸçš„è¯·æ±‚
> - æœ€åå°†è¯·æ±‚ä»£ç†å› `dev.server.com`

å¦‚ä¸‹é¢çš„é…ç½®ï¼š

```
server {
        listen       80;
        server_name  fe.server.com;
        location / {
                proxy_pass dev.server.com;
        }
}
```

è¿™æ ·å¯ä»¥å®Œç¾ç»•è¿‡æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼š

- `fe.server.com` è®¿é—® `nginx` çš„ `fe.server.com` å±äºåŒæºè®¿é—®
- è€Œ `nginx` å¯¹æœåŠ¡ç«¯è½¬å‘çš„è¯·æ±‚ä¸ä¼šè§¦å‘æµè§ˆå™¨çš„åŒæºç­–ç•¥ã€‚



## è¯·æ±‚è¿‡æ»¤

![](https://raw.githubusercontent.com/Cynthia0329/images/master/img/20190505180119.png)

**æ ¹æ®çŠ¶æ€ç è¿‡æ»¤**

```python
error_page 500 501 502 503 504 506 /50x.html;
    location = /50x.html {
        # å°†è·Ÿè·¯å¾„æ”¹ç¼–ä¸ºå­˜æ”¾htmlçš„è·¯å¾„ã€‚
        root /root/static/html;
    }
```

**æ ¹æ®URLåç§°è¿‡æ»¤**ï¼Œç²¾å‡†åŒ¹é…URLï¼Œä¸åŒ¹é…çš„URLå…¨éƒ¨é‡å®šå‘åˆ°ä¸»é¡µã€‚

```python
location / {
    rewrite  ^.*$ /index.html  redirect;
}
```

**æ ¹æ®è¯·æ±‚ç±»å‹è¿‡æ»¤ã€‚**

```python
if ( $request_method !~ ^(GET|POST|HEAD)$ ) {
        return 403;
    }
```





## é…ç½®gzip

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/gzip.jpg)](https://segmentfault.com/img/bVbpAX3?w=638&h=359)

`GZIP`æ˜¯è§„å®šçš„ä¸‰ç§æ ‡å‡†HTTPå‹ç¼©æ ¼å¼ä¹‹ä¸€ã€‚ç›®å‰ç»å¤§å¤šæ•°çš„ç½‘ç«™éƒ½åœ¨ä½¿ç”¨` GZIP `ä¼ è¾“ `HTML`ã€`CSS`ã€`JavaScript` ç­‰èµ„æºæ–‡ä»¶ã€‚

å¯¹äºæ–‡æœ¬æ–‡ä»¶ï¼Œ`GZip` çš„æ•ˆæœéå¸¸æ˜æ˜¾ï¼Œå¼€å¯åä¼ è¾“æ‰€éœ€æµé‡å¤§çº¦ä¼šé™è‡³ `1/4 ~ 1/3`ã€‚

å¹¶ä¸æ˜¯æ¯ä¸ªæµè§ˆå™¨éƒ½æ”¯æŒ`gzip`çš„ï¼Œå¦‚ä½•çŸ¥é“å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒ`gzip`å‘¢ï¼Œè¯·æ±‚å¤´ä¸­çš„`Accept-Encoding`æ¥æ ‡è¯†å¯¹å‹ç¼©çš„æ”¯æŒã€‚

![image](https://segmentfault.com/img/remote/1460000018454279?w=396&h=160)

å¯ç”¨`gzip`åŒæ—¶éœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„æ”¯æŒï¼Œå¦‚æœå®¢æˆ·ç«¯æ”¯æŒ`gzip`çš„è§£æï¼Œé‚£ä¹ˆåªè¦æœåŠ¡ç«¯èƒ½å¤Ÿè¿”å›`gzip`çš„æ–‡ä»¶å°±å¯ä»¥å¯ç”¨`gzip`äº†,æˆ‘ä»¬å¯ä»¥é€šè¿‡`nginx`çš„é…ç½®æ¥è®©æœåŠ¡ç«¯æ”¯æŒ`gzip`ã€‚ä¸‹é¢çš„`respone`ä¸­`content-encoding:gzip`ï¼ŒæŒ‡æœåŠ¡ç«¯å¼€å¯äº†`gzip`çš„å‹ç¼©æ–¹å¼ã€‚

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/gzip2.png)](https://segmentfault.com/img/bVbpAX1?w=415&h=183)

```
    gzip                    on;
    gzip_http_version       1.1;        
    gzip_comp_level         5;
    gzip_min_length         1000;
    gzip_types text/csv text/xml text/css text/plain text/javascript application/javascript application/x-javascript application/json application/xml;
```

#### gzip

- å¼€å¯æˆ–è€…å…³é—­`gzip`æ¨¡å—
- é»˜è®¤å€¼ä¸º` off`
- å¯é…ç½®ä¸º` on / off`

#### gzip_http_version

- å¯ç”¨ `GZip` æ‰€éœ€çš„` HTTP` æœ€ä½ç‰ˆæœ¬
- é»˜è®¤å€¼ä¸º` HTTP/1.1`

è¿™é‡Œä¸ºä»€ä¹ˆé»˜è®¤ç‰ˆæœ¬ä¸æ˜¯`1.0`å‘¢ï¼Ÿ

`HTTP` è¿è¡Œåœ¨` TCP` è¿æ¥ä¹‹ä¸Šï¼Œè‡ªç„¶ä¹Ÿæœ‰ç€è·Ÿ` TCP` ä¸€æ ·çš„ä¸‰æ¬¡æ¡æ‰‹ã€æ…¢å¯åŠ¨ç­‰ç‰¹æ€§ã€‚

å¯ç”¨æŒä¹…è¿æ¥æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å‘å‡ºå“åº”åè®©`TCP`è¿æ¥ç»§ç»­æ‰“å¼€ç€ã€‚åŒä¸€å¯¹å®¢æˆ·/æœåŠ¡å™¨ä¹‹é—´çš„åç»­è¯·æ±‚å’Œå“åº”å¯ä»¥é€šè¿‡è¿™ä¸ªè¿æ¥å‘é€ã€‚

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/keepalive.png)](https://segmentfault.com/img/bVbpAXX?w=742&h=210)

ä¸ºäº†å°½å¯èƒ½çš„æé«˜ `HTTP` æ€§èƒ½ï¼Œä½¿ç”¨æŒä¹…è¿æ¥å°±æ˜¾å¾—å°¤ä¸ºé‡è¦äº†ã€‚

`HTTP/1.1 `é»˜è®¤æ”¯æŒ` TCP `æŒä¹…è¿æ¥ï¼Œ`HTTP/1.0` ä¹Ÿå¯ä»¥é€šè¿‡æ˜¾å¼æŒ‡å®š `Connection: keep-alive` æ¥å¯ç”¨æŒä¹…è¿æ¥ã€‚å¯¹äº`TCP `æŒä¹…è¿æ¥ä¸Šçš„` HTTP` æŠ¥æ–‡ï¼Œå®¢æˆ·ç«¯éœ€è¦ä¸€ç§æœºåˆ¶æ¥å‡†ç¡®åˆ¤æ–­ç»“æŸä½ç½®ï¼Œè€Œåœ¨ `HTTP/1.0 `ä¸­ï¼Œè¿™ç§æœºåˆ¶åªæœ‰` Content-Length`ã€‚è€Œåœ¨`HTTP/1.1 `ä¸­æ–°å¢çš„ `Transfer-Encoding: chunked` æ‰€å¯¹åº”çš„åˆ†å—ä¼ è¾“æœºåˆ¶å¯ä»¥å®Œç¾è§£å†³è¿™ç±»é—®é¢˜ã€‚

`nginx`åŒæ ·æœ‰ç€é…ç½®`chunkedçš„`å±æ€§`chunked_transfer_encoding`ï¼Œè¿™ä¸ªå±æ€§æ˜¯é»˜è®¤å¼€å¯çš„ã€‚

`Nginx `åœ¨å¯ç”¨äº†`GZip`çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šç­‰æ–‡ä»¶ `GZip` å®Œæˆå†è¿”å›å“åº”ï¼Œè€Œæ˜¯è¾¹å‹ç¼©è¾¹å“åº”ï¼Œè¿™æ ·å¯ä»¥æ˜¾è‘—æé«˜ `TTFB`(`Time To First Byte`ï¼Œé¦–å­—èŠ‚æ—¶é—´ï¼ŒWEB æ€§èƒ½ä¼˜åŒ–é‡è¦æŒ‡æ ‡)ã€‚è¿™æ ·å”¯ä¸€çš„é—®é¢˜æ˜¯ï¼Œ`Nginx` å¼€å§‹è¿”å›å“åº”æ—¶ï¼Œå®ƒæ— æ³•çŸ¥é“å°†è¦ä¼ è¾“çš„æ–‡ä»¶æœ€ç»ˆæœ‰å¤šå¤§ï¼Œä¹Ÿå°±æ˜¯æ— æ³•ç»™å‡º` Content-Length `è¿™ä¸ªå“åº”å¤´éƒ¨ã€‚

æ‰€ä»¥ï¼Œåœ¨`HTTP1.0`ä¸­å¦‚æœåˆ©ç”¨`Nginx `å¯ç”¨äº†`GZip`ï¼Œæ˜¯æ— æ³•è·å¾—` Content-Length `çš„ï¼Œè¿™å¯¼è‡´HTTP1.0ä¸­å¼€å¯æŒä¹…é“¾æ¥å’Œä½¿ç”¨`GZip`åªèƒ½äºŒé€‰ä¸€ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œ`gzip_http_version`é»˜è®¤è®¾ç½®ä¸º`1.1`ã€‚

#### gzip_comp_level

- å‹ç¼©çº§åˆ«ï¼Œçº§åˆ«è¶Šé«˜å‹ç¼©ç‡è¶Šå¤§ï¼Œå½“ç„¶å‹ç¼©æ—¶é—´ä¹Ÿå°±è¶Šé•¿ï¼ˆä¼ è¾“å¿«ä½†æ¯”è¾ƒæ¶ˆè€—cpuï¼‰ã€‚
- é»˜è®¤å€¼ä¸º `1`
- å‹ç¼©çº§åˆ«å–å€¼ä¸º`1-9`

#### gzip_min_length

- è®¾ç½®å…è®¸å‹ç¼©çš„é¡µé¢æœ€å°å­—èŠ‚æ•°ï¼Œ`Content-Length`å°äºè¯¥å€¼çš„è¯·æ±‚å°†ä¸ä¼šè¢«å‹ç¼©
- é»˜è®¤å€¼:`0`
- å½“è®¾ç½®çš„å€¼è¾ƒå°æ—¶ï¼Œå‹ç¼©åçš„é•¿åº¦å¯èƒ½æ¯”åŸæ–‡ä»¶å¤§ï¼Œå»ºè®®è®¾ç½®`1000`ä»¥ä¸Š

#### gzip_types

- è¦é‡‡ç”¨gzipå‹ç¼©çš„æ–‡ä»¶ç±»å‹(`MIME`ç±»å‹)
- é»˜è®¤å€¼:`text/html`(é»˜è®¤ä¸å‹ç¼©`js`/`css`)

## è´Ÿè½½å‡è¡¡

#### ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/nginx3.jpg)](https://segmentfault.com/img/bVbpAX0?w=1024&h=678)

å¦‚ä¸Šé¢çš„å›¾ï¼Œå‰é¢æ˜¯ä¼—å¤šçš„æœåŠ¡çª—å£ï¼Œä¸‹é¢æœ‰å¾ˆå¤šç”¨æˆ·éœ€è¦æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå·¥å…·æˆ–ç­–ç•¥æ¥å¸®åŠ©æˆ‘ä»¬å°†å¦‚æ­¤å¤šçš„ç”¨æˆ·åˆ†é…åˆ°æ¯ä¸ªçª—å£ï¼Œæ¥è¾¾åˆ°èµ„æºçš„å……åˆ†åˆ©ç”¨ä»¥åŠæ›´å°‘çš„æ’é˜Ÿæ—¶é—´ã€‚

æŠŠå‰é¢çš„æœåŠ¡çª—å£æƒ³åƒæˆæˆ‘ä»¬çš„åç«¯æœåŠ¡å™¨ï¼Œè€Œåé¢ç»ˆç«¯çš„äººåˆ™æ˜¯æ— æ•°ä¸ªå®¢æˆ·ç«¯æ­£åœ¨å‘èµ·è¯·æ±‚ã€‚è´Ÿè½½å‡è¡¡å°±æ˜¯ç”¨æ¥å¸®åŠ©æˆ‘ä»¬å°†ä¼—å¤šçš„å®¢æˆ·ç«¯è¯·æ±‚åˆç†çš„åˆ†é…åˆ°å„ä¸ªæœåŠ¡å™¨ï¼Œä»¥è¾¾åˆ°æœåŠ¡ç«¯èµ„æºçš„å……åˆ†åˆ©ç”¨å’Œæ›´å°‘çš„è¯·æ±‚æ—¶é—´ã€‚

#### nginxå¦‚ä½•å®ç°è´Ÿè½½å‡è¡¡

UpstreamæŒ‡å®šåç«¯æœåŠ¡å™¨åœ°å€åˆ—è¡¨

```
upstream balanceServer {
    server 10.1.22.33:12345;
    server 10.1.22.34:12345;
    server 10.1.22.35:12345;
}
```

åœ¨serverä¸­æ‹¦æˆªå“åº”è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°Upstreamä¸­é…ç½®çš„æœåŠ¡å™¨åˆ—è¡¨ã€‚

```
    server {
        server_name  fe.server.com;
        listen 80;
        location /api {
            proxy_pass http://balanceServer;
        }
    }
```

ä¸Šé¢çš„é…ç½®åªæ˜¯æŒ‡å®šäº†nginxéœ€è¦è½¬å‘çš„æœåŠ¡ç«¯åˆ—è¡¨ï¼Œå¹¶æ²¡æœ‰æŒ‡å®šåˆ†é…ç­–ç•¥ã€‚

#### nginxå®ç°è´Ÿè½½å‡è¡¡çš„ç­–ç•¥

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/loadBalancing.png)](https://segmentfault.com/img/bVbpAXZ?w=1024&h=770)

**è½®è¯¢ç­–ç•¥**

é»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨çš„ç­–ç•¥ï¼Œå°†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚è½®è¯¢åˆ†é…ç»™æœåŠ¡ç«¯ã€‚è¿™ç§ç­–ç•¥æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ï¼Œä½†æ˜¯å¦‚æœå…¶ä¸­æŸä¸€å°æœåŠ¡å™¨å‹åŠ›å¤ªå¤§ï¼Œå‡ºç°å»¶è¿Ÿï¼Œä¼šå½±å“æ‰€æœ‰åˆ†é…åœ¨è¿™å°æœåŠ¡å™¨ä¸‹çš„ç”¨æˆ·ã€‚

```
upstream balanceServer {
    server 10.1.22.33:12345;
    server 10.1.22.34:12345;
    server 10.1.22.35:12345;
}
```

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/nginx5.png)](https://segmentfault.com/img/bVbpAXW?w=1024&h=770)

**æœ€å°è¿æ¥æ•°ç­–ç•¥**

å°†è¯·æ±‚ä¼˜å…ˆåˆ†é…ç»™å‹åŠ›è¾ƒå°çš„æœåŠ¡å™¨ï¼Œå®ƒå¯ä»¥å¹³è¡¡æ¯ä¸ªé˜Ÿåˆ—çš„é•¿åº¦ï¼Œå¹¶é¿å…å‘å‹åŠ›å¤§çš„æœåŠ¡å™¨æ·»åŠ æ›´å¤šçš„è¯·æ±‚ã€‚

```
upstream balanceServer {
    least_conn;
    server 10.1.22.33:12345;
    server 10.1.22.34:12345;
    server 10.1.22.35:12345;
}
```

![![image](https://lsqimg-1257917459.cos-website.ap-beijing.myqcloud.com/blog/nginx4.png)](https://segmentfault.com/img/bVbpAXY?w=1024&h=770)

**æœ€å¿«å“åº”æ—¶é—´ç­–ç•¥**

ä¾èµ–äºNGINX Plusï¼Œä¼˜å…ˆåˆ†é…ç»™å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡å™¨ã€‚

```
upstream balanceServer {
    fair;
    server 10.1.22.33:12345;
    server 10.1.22.34:12345;
    server 10.1.22.35:12345;
}
```

**å®¢æˆ·ç«¯ipç»‘å®š**

æ¥è‡ªåŒä¸€ä¸ªipçš„è¯·æ±‚æ°¸è¿œåªåˆ†é…ä¸€å°æœåŠ¡å™¨ï¼Œæœ‰æ•ˆè§£å†³äº†åŠ¨æ€ç½‘é¡µå­˜åœ¨çš„sessionå…±äº«é—®é¢˜ã€‚

```
upstream balanceServer {
    ip_hash;
    server 10.1.22.33:12345;
    server 10.1.22.34:12345;
    server 10.1.22.35:12345;
}
```

## é™æ€èµ„æºæœåŠ¡å™¨

```
location ~* \.(png|gif|jpg|jpeg)$ {
    root    /root/static/;  
    autoindex on;
    access_log  off;
    expires     10h;# è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º10å°æ—¶          
}
```

åŒ¹é…ä»¥`png|gif|jpg|jpeg`ä¸ºç»“å°¾çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°æœ¬åœ°è·¯å¾„ï¼Œ`root`ä¸­æŒ‡å®šçš„è·¯å¾„å³nginxæœ¬åœ°è·¯å¾„ã€‚åŒæ—¶ä¹Ÿå¯ä»¥è¿›è¡Œä¸€äº›ç¼“å­˜çš„è®¾ç½®ã€‚

## å°ç»“

nginxçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œè¿˜æœ‰å¾ˆå¤šéœ€è¦æ¢ç´¢ï¼Œä¸Šé¢çš„ä¸€äº›é…ç½®éƒ½æ˜¯å…¬å¸é…ç½®çš„çœŸå®åº”ç”¨ï¼ˆç²¾ç®€è¿‡äº†ï¼‰ï¼Œå¦‚æœæ‚¨æœ‰ä»€ä¹ˆæ„è§æˆ–è€…å»ºè®®ï¼Œæ¬¢è¿åœ¨ä¸‹æ–¹ç•™è¨€...





<br>

---

> æ­¤å¤„åªæ˜¯ä¸€ä¸ªæ€»ç»“æ•´ç†ï¼ŒéåŸåˆ›ï¼ŒåŸæ–‡æ¥è‡ªï¼š
>
> <https://segmentfault.com/a/1190000018454271>